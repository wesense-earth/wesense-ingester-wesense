version: '3.8'

services:
  # SkyTrace Decoder - Protobuf to JSON translator
  skytrace-decoder:
    build: .
    image: skytrace/decoder:latest
    container_name: skytrace-decoder
    restart: unless-stopped
    volumes:
      - ./config:/app/config
      - ./logs:/app/logs
    networks:
      - skytrace
    depends_on:
      - mosquitto
    environment:
      - PUID=1000  # Change to 568 for TrueNAS
      - PGID=1000  # Change to 568 for TrueNAS
      - TZ=Pacific/Auckland
      - MQTT_BROKER=mosquitto  # Use service name in compose network
      - MQTT_PORT=1883
      - MQTT_SUBSCRIBE_TOPICS=skytrace/esp32/env/#,skytrace/lorawan/env/#
      - MQTT_PRESERVE_TOPICS=false
      - MQTT_TOPIC_PREFIX=skytrace/decoded/env
      - LOG_LEVEL=INFO
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # MQTT Broker (if you don't have one already)
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: skytrace-mqtt
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config:ro
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - skytrace
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  skytrace:
    driver: bridge
